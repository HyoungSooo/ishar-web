{% extends "layout.html.j2" %}
{% block meta_title %}Essence Shop{% endblock meta_title %}
{% block meta_description %}View and spend your seasonally rewarded essence points{% endblock%}
{% block meta_url %}{{ url_for('essence_shop', _external=True) }}{% endblock meta_url %}">
{% block title %}Essence Shop{% endblock %}
{% block header %}Essence Shop{% endblock %}
{%- macro render_field(field) %}
                    <ul class="essence-shop">
    {% for subfield in field %}
                        <li class="essence-upgrades">
                            {{ subfield }}
                            {{ subfield.label }}
                            <ul>
                                <li>
                                    {{ account_upgrades[subfield.data | int - 1].description }}
                                </li>
        {%- if current_user.seasonal_points >= account_upgrades[subfield.data | int - 1].cost  %}
            {%- set cost_css = 'success' %}
        {%- else %}
            {%- set cost_css = 'error' %}
        {%- endif %}
                                <li title="Cost: {{ account_upgrades[subfield.data | int - 1].cost }} essence">
                                    <span class="flash-{{ cost_css }}">{{ account_upgrades[subfield.data | int - 1].cost }} essence</span>
                                </li>
                            </ul>
                        </li>
    {% endfor %}
                    </ul>
    {%- if field.errors %}
                <ul class="field-errors">
        {%- for error in field.errors %}
                    <li>
                        {{ error }}
                    </li>
        {%- endfor %}
                </ul>
    {%- endif %}
{%- endmacro %}
{%- block content %}
                <p>
                    Welcome to the seasonal shop! This is where you can find information on the
                    current season, as well as view your accumulated essence balance and spend it
                    to upgrade your account.
                </p>
                <ul class="essence-shop">
                    <li>
                        You currently have: <strong>{{ current_user.seasonal_points }} essence</strong>.
                    </li>
                </ul>
                <ul class="essence-shop">
                    <li>
                        This season, you have earned: <strong>{{ current_user.seasonal_earned }} essence</strong>.
                    </li>
                </ul>
                <h4>
                    Upgrades
                </h4>
    {%- if current_user.account_upgrades is defined and current_user.account_upgrades is iterable and current_user.account_upgrades | selectattr('amount', '>', 0) | list | length > 0 %}
                <ul class="essence-shop">
            {%- for upgrade in current_user.account_upgrades | selectattr('amount', '>', 0) %}
                    <li>
                        <strong>{{ upgrade.account_upgrade.name }}</strong>
                        <ul>
                            <li>
                                {{ upgrade.account_upgrade.description }}
                            </li>
                            <li>
                                Amount: {{ upgrade.amount }}
                            </li>
                        </ul>
                    </li>
            {%- endfor %}
                </ul>
    {%- else %}
                <ul>
                    <li>
                        <i>You have not purchased any upgrades.</i>
                    </li>
                </ul>
    {%- endif %}
    {%- if essence_shop_form is defined %}
                <h4>
                    Purchase
                </h4>
                <form method="post" action="{{ url_for('essence_shop') }}" id="essence-shop-form">
                    {{ render_field(essence_shop_form.upgrade) }}
                    {{ essence_shop_form.csrf_token }}
                    {{ essence_shop_form.submit }}
                </form>
    {%- endif %}
{% include('back.html.j2') %}
{%- endblock %}
