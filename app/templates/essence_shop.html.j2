{% extends "layout.html.j2" %}
{% block meta_title %}Essence Shop{% endblock meta_title %}
{% block meta_description %}View and spend your seasonally rewarded essence points{% endblock%}
{% block meta_url %}{{ url_for('essence_shop', _external=True) }}{% endblock meta_url %}">
{% block title %}Essence Shop{% endblock %}
{% block header %}Essence Shop{% endblock %}
{%- block scripts %}
        <script>

            // Create a JavaScript function to confirm with the user how much they are spending
            function confirmSpend() {

                // Set the account upgrades and find chosen
                const upgrades  = {
                    {%- for upgrade in current_user.upgrades %}
                    {{ upgrade.account_upgrades_id }} : { amount: {{ upgrade.amount }}, cost: {{ upgrade.upgrade.cost }}, max_value: {{ upgrade.upgrade.max_value }}, name: '{{ upgrade.upgrade.name }}' }
                    {%- if not loop.last %}, {% endif %}
                {%- endfor %}
                };
                const radios    = document.getElementsByName('upgrade');
                const selected  = Array.from(radios).find(radio => radio.checked);
                const upgrade   = upgrades[selected.value];

                // Account Upgrade ID 4 ("Improved Starting Gear") is a work-in-progress
                if (selected.value == 4) {
                    alert('Sorry, but this upgrade (' + upgrade.name + ') is still a work in progress.');
                    return false;

                // Do not let users upgrade beyond max
                } else if ( upgrade.amount >= upgrade.max_value) {
                    alert('Sorry, but you already have the max value in that upgrade (' + upgrade.name + ').');
                    return false;

                // Do not let users spend essence they do not have
                } else if ({{ current_user.seasonal_points }} < upgrade.cost) {
                    alert('Sorry, but you do not have enough essence to acquire that upgrade (' + upgrade.name + ').');
                    return false;
                };

                // Proceed by having the user confirm their choice
                return confirm('Are you sure you want to spend ' + upgrade.cost + ' essence for ' + upgrade.name + '?');
            };

        </script>
{%- endblock scripts %}
{%- macro render_field(field) %}
            <ul class="essence-shop">
    {%- for subfield in field %}
                <li class="essence-upgrades" title="{{ subfield.label | striptags }}">
                    {{ subfield }}
                    {{ subfield.label }}
                    <ul>
        {%- for ug in current_user.upgrades | selectattr('account_upgrades_id', 'equalto', subfield.data) %}
                        <li title="{{ ug.upgrade.description | replace('\n', ' ') }}">
                            {{ ug.upgrade.description | replace('\n', ' ')}}
                        </li>
            {%- if current_user.seasonal_points < ug.upgrade.cost %}
                {%- set cost_css = 'error' %}
            {%- else %}
                {%- set cost_css = 'success' %}
            {%- endif %}
                        <li title="Cost: {{ ug.upgrade.cost }} essence">
                            <span class="flash-{{ cost_css }}">{{ ug.upgrade.cost }} essence</span>
                        </li>
        {%- endfor %}
                    </ul>
                </li>
    {%- endfor %}
            </ul>
    {%- if field.errors %}
                    <ul class="field-errors">
        {%- for error in field.errors %}
                        <li title="{{ error }}">
                            {{ error }}
                        </li>
        {%- endfor %}
                    </ul>
    {%- endif %}
{%- endmacro -%}
{%- block content %}
            <p>
                <strong>
                    Welcome to the seasonal shop!
                </strong>
            </p>
            <p>
                This is where you can find information on the current season
                as well as view your accumulated essence balance and spend it to upgrade your account.
            </p>
            <ul class="essence-shop">
                <li title="You currently have: {{ current_user.seasonal_points }} essence.">
                    You currently have:
    {%- if current_user.seasonal_points > 0 %}
                    <strong>{{ current_user.seasonal_points }} essence</strong>.
    {%- else %}
                    <span class="flash-error">{{ current_user.seasonal_points }} essence</span>.
    {%- endif %}
                </li>
            </ul>
            <ul class="essence-shop">
                <li title="This season, you have earned: {{ current_user.seasonal_earned }} essence.">
                    This season, you have earned: <strong>{{ current_user.seasonal_earned }} essence</strong>.
                </li>
            </ul>
            <h4 title="Upgrades">
                Upgrades
            </h4>
    {%- if current_user.upgrades is defined and current_user.upgrades is iterable and current_user.upgrades | selectattr('amount', '>', 0) | list | length > 0 %}
            <ul class="essence-shop">
        {%- for upgraded in current_user.upgrades | selectattr('amount', '>', 0) %}
                <li title="{{ upgraded.upgrade.name }}">
                    <strong>{{ upgraded.upgrade.name }}</strong>{% if upgraded.amount > 1 %} (x{{ upgraded.amount}}){% endif %}
                </li>
        {%- endfor %}
            </ul>
    {%- else %}
            <ul>
                <li>
                    <i>You have not purchased any upgrades.</i>
                </li>
            </ul>
    {%- endif %}
    {%- if essence_shop_form is defined %}
            <h4 title="Purchase">
                Purchase
            </h4>
            <form method="post" action="{{ url_for('essence_shop') }}" id="essence-shop-form" onSubmit="return confirmSpend();">
                {{ render_field(essence_shop_form.upgrade) }}
                {{ essence_shop_form.csrf_token }}
                {{ essence_shop_form.submit }}
            </form>
    {%- endif %}
{% include('back.html.j2') %}
{%- endblock %}
