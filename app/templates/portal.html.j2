{% extends "layout.html.j2" %}
{% block title %}Portal{% endblock %}
{% block header %}Welcome{% if current_user.account_name is defined %}, {{ current_user.account_name | title | safe }}{% endif %}!{% endblock %}
{%- macro challenge_tier(tier) -%}
{%- set challenge_tiers = {
    9: 'SS',
    8: 'SS',
    7: 'SS',
    6: 'S',
    5: 'A',
    4: 'B',
    3: 'C',
    2: 'D',
    1: 'F' } -%}
{%- if challenge_tiers[tier] is defined  -%}
                            {{ challenge_tiers[tier] }}
{%- else -%}
                            {{ tier }}
{%- endif -%}
{%- endmacro -%}
{%- block content %}
                {%- if current_user.seasonal_points is defined and current_user.seasonal_points > 0 %}
                <h3 id="essence">
                    <span title="Essence: {{ current_user.seasonal_points }}">
                        Essence: {{ current_user.seasonal_points }}
                    </span>
                </h3>
                {%- endif %}
                {%- if current_user.players is defined and current_user.players is iterable and current_user.players|length > 0 %}
                <h3 id="renown">
                    <span title="Renown: {{ current_user.players | sum(attribute='renown') }} ({{ current_user.players | sum(attribute='total_renown') }})">
                        Renown: {{ current_user.players | sum(attribute='renown') }} ({{ current_user.players | sum(attribute='total_renown') }})
                    </span>
                </h3>
                <h3>
                    {{ current_user.players | length }} character{% if current_user.players|length != 1 %}s{% endif %}:
                </h3>
                <br>
                <table>
                    <tr>
                        <th>
                            Name
                        </th>
                        <th>
                            Class
                        </th>
                        <th>
                            Race
                        </th>
                        <th>
                            Level
                        </th>
                        <th>
                            Remorts
                        </th>
                        <th>
                            Renown (Total)
                        </th>
                        <th>
                            Deaths
                        </th>
                        <th>
                            Type
                        </th>
                    </tr>
                    {%- for player in current_user.players %}
                    <tr>
                        {%- set player_title    = player.title | replace('%s', '<strong><a href="' + url_for('show_player', player_name=player.name) + '">' + player.name + '</a></strong>') %}
                        {%- set survival_dead   = False -%}
                        {#- FIXME: 45 = hard-coded value for PERM_DEATH player_flag #}
                        {%- if player.player_flags[45].value == 1 %}
                            {%- set player_type = 'Survival' %}
                            {%- if player.curr_endurance <= 0 and player.deaths > 0 %}
                                {%- set survival_dead   = True -%}
                            {%- endif %}
                        {%- else %}
                            {%- set player_type = 'Classic' %}
                        {%- endif %}
                        <td{%- if survival_dead == True or player.is_deleted == 1 %} class="player-gone"{%- endif %}>
                            <span title="{{ player.name | title | safe }} (Born {{ player.birth | unix2human_time }})">
                                {{ player_title | safe }}
                            </span>
                        </td>
                        <td{%- if survival_dead == True or player.is_deleted == 1 %} class="player-gone"{%- endif %}>
                            <span title="Class: {{ player.player_class.class_name | replace('_', '-') | title | safe }}">
                                {{ player.player_class.class_name | replace('_', '-') | title | safe }}
                            </span>
                        </td>
                        <td{%- if survival_dead == True or player.is_deleted == 1 %} class="player-gone"{%- endif %}>
                            <span title="Race: {{ player.player_race.race_name | replace('_', '-') | title | safe }}">
                                {{ player.player_race.race_name | replace('_', '-') | title | safe }}
                            </span>
                        </td>
                        <td>
                            <span title="Level: {{ player.level }}">
                                {{ player.level }}
                            </span>
                        </td>
                        <td>
                            <span title="Remorts: {{ player.remorts }}">
                                {{ player.remorts }}
                            </span>
                        </td>
                        <td>
                            <span title="Renown: {{ player.renown }} ({{ player.total_renown }})">
                                {{ player.renown }} ({{ player.total_renown }})
                            </span>
                        </td>
                        <td>
                            <span title="Deaths: {{ player.deaths }}">
                                {{ player.deaths }}
                            </span>
                        </td>
                        <td>
                            <span title="Type: {{ player_type }}" class="{{ player_type | lower }}-player">
                                {{ player_type }}
                            </span>
                            {%- if survival_dead == True %}
                            <span title="Dead">
                                ☠️
                            </span>
                            {%- endif %}
                            {%- if player.is_deleted == 1 %}
                            <span title="Deleted">
                                (Deleted)
                            </span>
                            {%- endif %}
                        </td>
                    </tr>
                    {%- endfor %}
                </table>
                <br>
                {%- if quests is defined and quests is iterable and quests|length > 0 %}
                <!--
                <ul>
                    {%- for quest in quests %}
                    <li>
                        {{ quest }}
                    </li>
                    {%- endfor %}
                </ul>
                -->
                {%- endif %}
                {%- else %}
                <h3>
                    You have not created any players yet!
                </h3>
                {%- endif %}
                {%- if challenges is defined and challenges is iterable and challenges|length > 1 %}
                <h3>
                    Challenges
                </h3>
                <table>
                    <tr>
                        <th>
                            Find and Kill
                        </th>
                        <th>
                            Max People
                        </th>
                        <th>
                            Max Level
                        </th>
                        <th>
                            Reward Tier
                        </th>
                        <th>
                            Completed by
                        </th>
                    </tr>
                    {%- for challenge in challenges %}
                    <tr>
                        <td{%- if challenge.winner_desc != "" %} class="challenge-completed"{%- endif %}>
                            {{ challenge.mob_name }}
                        </td>
                        <td>
                            {{ challenge.adj_people }}
                        </td>
                        <td>
                            {{ challenge.adj_level }}
                        </td>
                        <td>
                            {{ challenge_tier(challenge.adj_tier) }}
                        </td>
                        <td>
                            {{ challenge.winner_desc }}
                        </td>
                    </tr>
                {%- endfor %}
                </table>
                {%- endif %}
                <p id="change-password-link">
                    <a title="Change Password" href="{{ url_for('change_password') }}">Change Password</a>
                </p>
                {%- if is_admin is defined and is_admin == True %}
                <p id="admin-link">
                    <a title="Administration Portal" href="{{ url_for('admin_portal') }}">Administration</a>
                </p>
                {%- endif %}
{%- endblock %}
{% block footer %}
            {%- if current_user.created_at is defined and current_user.created_at != '' %}
            <span id="created">
                <strong>Account Created</strong>:<br>
                {{ current_user.created_at.strftime('%A, %B %d, %Y %I:%M %p %Z') }}
            </span>
            {%- endif %}
            {%- if season.season_id is defined and season.expiration_date is defined %}
            <span id="season">
                <strong>Season {{ season.season_id }}</strong>:<br>
                ends {{ season.expiration_date | unix2human_time }}
            </span>
            {%- endif %}
{%- endblock %}
